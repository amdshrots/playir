name: The Final Guaranteed WireGuard Gateway
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Build, Configure, and Display All
        id: main_build
        run: |
          # --- PART A: DOWNLOAD AND WAIT FOR INSTALL ---
          Write-Host "Downloading tools..."
          Invoke-WebRequest -Uri "https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-windows-x86_64-signed.exe" -OutFile "$env:USERPROFILE\playit.exe"
          Invoke-WebRequest -Uri "https://download.wireguard.com/windows-client/wireguard-amd64-0.5.3.msi" -OutFile "wireguard.msi"
          
          Write-Host "Installing WireGuard and WAITING for completion..."
          # THIS IS THE FIX: Start-Process with -Wait forces the script to pause until the installation is 100% finished.
          Start-Process -FilePath "msiexec.exe" -ArgumentList "/i wireguard.msi /qn" -Wait
          Write-Host "WireGuard installation complete. Proceeding..."

          # --- PART B: FORGE KEYS & CONFIGURE SERVER ---
          # Now that we know the path exists, we can proceed.
          cd "C:\Program Files\WireGuard"
          
          Write-Host "Generating cryptographic keys..."
          $serverPrivateKey = (.\wg.exe genkey)
          $serverPublicKey = ($serverPrivateKey | .\wg.exe pubkey)
          $clientPrivateKey = (.\wg.exe genkey)
          $clientPublicKey = ($clientPrivateKey | .\wg.exe pubkey)

          Write-Host "Configuring the remote server..."
          @"
          [Interface]
          PrivateKey = $serverPrivateKey
          Address = 10.0.0.1/24
          ListenPort = 51820
          [Peer]
          PublicKey = $clientPublicKey
          AllowedIPs = 10.0.0.2/32
          "@ | Set-Content wg0.conf
          .\wireguard.exe /installservice wg0.conf
          New-NetNat -Name "WireGuardNAT" -InternalIPInterfaceAddressPrefix 10.0.0.0/24

          # --- PART C: START PLAYIT AGENT ---
          Write-Host "Starting Playit.gg agent..."
          Start-Process -FilePath "$env:USERPROFILE\playit.exe" -ArgumentList "--secret ${{ secrets.PL }}" -NoNewWindow
          
          # --- PART D: DISPLAY THE FINAL, COMPLETE CLIENT CONFIG ---
          Write-Host "--- COPY EVERYTHING BELOW THIS LINE INTO A NEW WIREGUARD TUNNEL ---"
          Write-Host "[Interface]"
          Write-Host "PrivateKey = $clientPrivateKey"
          Write-Host "Address = 10.0.0.2/24"
          Write-Host "DNS = 1.1.1.1"
          Write-Host ""
          Write-Host "[Peer]"
          Write-Host "PublicKey = $serverPublicKey"
          Write-Host "Endpoint = YOUR_PLAYIT_UDP_ADDRESS:PORT"
          Write-Host "AllowedIPs = 0.0.0.0/0"
          Write-Host "PersistentKeepalive = 25"
          Write-Host "------------------------------------------------------------------"

      - name: Keep Runner Alive
        run: Start-Sleep -Seconds 21000
