name: Autonomous WireGuard VPN Gateway
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Download Tools
        run: |
          Invoke-WebRequest -Uri "https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-windows-x86_64-signed.exe" -OutFile "$env:USERPROFILE\playit.exe"
          Invoke-WebRequest -Uri "https://download.wireguard.com/windows-client/wireguard-amd64-0.5.3.msi" -OutFile "wireguard.msi"
          msiexec.exe /i "wireguard.msi" /qn

      - name: Generate All Keys and Configure Server
        run: |
          cd "C:\Program Files\WireGuard"
          # FORGE THE SERVER'S KEYS
          $serverPrivateKey = (.\wg.exe genkey)
          $serverPublicKey = ($serverPrivateKey | .\wg.exe pubkey)
          
          # FORGE A NEW, DISPOSABLE KEY PAIR FOR THE CLIENT
          $clientPrivateKey = (.\wg.exe genkey)
          $clientPublicKey = ($clientPrivateKey | .\wg.exe pubkey)
          
          # Save the client private key to a temporary file so the next step can access it
          $clientPrivateKey | Set-Content "C:\Program Files\WireGuard\client-private.key"

          # Configure the server using the keys we just made
          @"
          [Interface]
          PrivateKey = $serverPrivateKey
          Address = 10.0.0.1/24
          ListenPort = 51820
          
          [Peer]
          PublicKey = $clientPublicKey
          AllowedIPs = 10.0.0.2/32
          "@ | Set-Content wg0.conf
          
          .\wireguard.exe /installservice wg0.conf

      - name: Enable Internet Sharing (NAT)
        run: New-NetNat -Name "WireGuardNAT" -InternalIPInterfaceAddressPrefix 10.0.0.0/24

      - name: Start Playit.gg Agent
        env:
          PLAYIT_AUTH_KEY: ${{ secrets.PL }} 
        run: Start-Process -FilePath "$env:USERPROFILE\playit.exe" -ArgumentList "--secret $env:PLAYIT_AUTH_KEY" -NoNewWindow
          
      - name: Display THE COMPLETE, FINAL Client Configuration
        id: display_config # Give this step an ID
        run: |
          $serverPublicKey = Get-Content "C:\Program Files\WireGuard\server-public.key"
          $clientPrivateKey = Get-Content "C:\Program Files\WireGuard\client-private.key"

          # This block writes the final, perfect config file to the console
          echo "--- COPY EVERYTHING BELOW THIS LINE INTO A NEW WIREGUARD TUNNEL ---"
          echo "[Interface]"
          echo "PrivateKey = $clientPrivateKey"
          echo "Address = 10.0.0.2/24"
          echo "DNS = 1.1.1.1"
          echo ""
          echo "[Peer]"
          echo "PublicKey = $serverPublicKey"
          echo "Endpoint = YOUR_PLAYIT_UDP_ADDRESS:PORT"
          echo "AllowedIPs = 0.0.0.0/0"
          echo "PersistentKeepalive = 25"
          echo "------------------------------------------------------------------"

      - name: Keep Runner Alive
        run: Start-Sleep -Seconds 21000
