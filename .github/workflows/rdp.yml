name: WireGuard VPN Gateway (Internet Sharing Enabled)
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Download Tools (Playit & WireGuard)
        run: |
          Invoke-WebRequest -Uri "https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-windows-x86_64-signed.exe" -OutFile "$env:USERPROFILE\playit.exe"
          Invoke-WebRequest -Uri "https://download.wireguard.com/windows-client/wireguard-amd64-0.5.3.msi" -OutFile "wireguard.msi"
          msiexec.exe /i "wireguard.msi" /qn

      - name: Configure and Start WireGuard Server
        run: |
          cd "C:\Program Files\WireGuard"
          .\wg.exe genkey | Set-Content server-private.key
          Get-Content server-private.key | .\wg.exe pubkey | Set-Content server-public.key
          
          $serverPrivateKey = Get-Content server-private.key
          @"
          [Interface]
          PrivateKey = $serverPrivateKey
          Address = 10.0.0.1/24
          ListenPort = 51820
          "@ | Set-Content wg0.conf
          
          .\wireguard.exe /installservice wg0.conf
          
      # --- THE FIX: THIS IS THE MOST IMPORTANT STEP ---
      - name: Enable Internet Sharing (NAT)
        run: New-NetNat -Name "WireGuardNAT" -InternalIPInterfaceAddressPrefix 10.0.0.0/24
      # -----------------------------------------------

      - name: Start Playit.gg Agent
        env:
          PLAYIT_AUTH_KEY: ${{ secrets.PL }} 
        run: Start-Process -FilePath "$env:USERPROFILE\playit.exe" -ArgumentList "--secret $env:PLAYIT_AUTH_KEY" -NoNewWindow
          
      - name: Display Client Configuration
        run: |
          echo "--- YOUR WIREGUARD CLIENT CONFIG ---"
          echo "[Interface]"
          echo "PrivateKey = PASTE_YOUR_LOCAL_PC_PRIVATE_KEY_HERE"
          echo "Address = 10.0.0.2/24"
          echo "DNS = 1.1.1.1"
          echo ""
          echo "[Peer]"
          $serverPublicKey = Get-Content "C:\Program Files\WireGuard\server-public.key"
          echo "PublicKey = $serverPublicKey"
          echo "Endpoint = YOUR_PLAYIT_UDP_ADDRESS:PORT"
          echo "AllowedIPs = 0.0.0.0/0"
          echo "------------------------------------"

      - name: Keep Runner Alive
        run: Start-Sleep -Seconds 21000
