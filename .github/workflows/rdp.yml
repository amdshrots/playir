name: Playit.gg Tunnel Workflow (APT Method)

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Set up SSH Server
      run: |
        sudo apt-get update
        sudo apt-get install -y openssh-server
        sudo bash -c 'echo "runner:runnerpassword" | chpasswd' # You can change this password
        sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo sed -i 's/PasswordAuthentication no/#PasswordAuthentication no/' /etc/ssh/sshd_config
        sudo service ssh start
        echo "SSH Server is running."

    - name: Install and Run playit.gg Agent
      run: |
        # Add the playit.gg repository key and source
        curl -SsL https://playit-cloud.github.io/ppa/key.gpg | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/playit.gpg >/dev/null
        echo "deb [signed-by=/etc/apt/trusted.gpg.d/playit.gpg] https://playit-cloud.github.io/ppa/data ./" | sudo tee /etc/apt/sources.list.d/playit-cloud.list
        
        # Update package list and install playit
        sudo apt update
        sudo apt install -y playit
        
        echo "Playit.gg agent installed via apt. Starting tunnel with secret key..."
        echo "The tunnel will now connect. Check your playit.gg dashboard."
        
        # Run the agent using the secret. Because it's installed via apt,
        # the 'playit' command is now in the system's PATH.
        playit --secret ${{ secrets.PL }}
