name: RDP & SSH Gateway
on:
  workflow_dispatch:
jobs:
  setup-gateway:
    runs-on: windows-latest
    steps:
      - name: Configure RDP & SSH Server
        run: |
          # Enable RDP and set user password
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1
          Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "p@ssw0rd!" -Force)
          
          # Install and start the native OpenSSH Server
          Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
          Set-Service -Name sshd -StartupType 'Automatic'
          Start-Service sshd

      - name: Start Playit.gg Agent
        env:
          PLAYIT_AUTH_KEY: ${{ secrets.PL }} 
        run: Start-Process -FilePath "C:\Users\runneradmin\playit.exe" -ArgumentList "--secret $env:PLAYIT_AUTH_KEY" -NoNewWindow

      - name: Keep Runner Alive
        run: Start-Sleep -Seconds 21000
